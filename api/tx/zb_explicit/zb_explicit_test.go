package zb_explicit

import (
	"github.com/pauleyj/gobee/api/tx"
	"testing"
)

var _ tx.Frame = (*ZBExplicit)(nil)

type zbTest struct {
	name     string
	input    *ZBExplicit
	expected []byte
}

var zbTests = []zbTest{
	{"ZB Defaults",
		NewZBExplicit(),
		[]byte{zbExplicitAPIID, 0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},
	{"ZB FrameID",
		NewZBExplicit(FrameID(1)),
		[]byte{zbExplicitAPIID, 1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},
	{"ZB Addresses",
		NewZBExplicit(Addr64(0x0001020304050607), Addr16(0x0102)),
		[]byte{zbExplicitAPIID, 0, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x01, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},
	{"ZB Src EP",
		NewZBExplicit(SrcEP(0xaa)),
		[]byte{zbExplicitAPIID, 0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xfe, 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00}},
	{"ZB Dst EP",
		NewZBExplicit(DstEP(0xaa)),
		[]byte{zbExplicitAPIID, 0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xfe, 0x00, 0xaa, 0x00, 0x00, 0x00, 0x00}},
	{"ZB Cluster ID",
		NewZBExplicit(ClusterID(0xaa)),
		[]byte{zbExplicitAPIID, 0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0xaa, 0x00, 0x00, 0x00}},
	{"ZB Profile ID",
		NewZBExplicit(ProfileID(0xaa)),
		[]byte{zbExplicitAPIID, 0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0xaa, 0x00, 0x00}},
	{"ZB Broadcast Radius",
		NewZBExplicit(BroadcastRadius(0xaa)),
		[]byte{zbExplicitAPIID, 0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0xaa, 0x00}},
	{"ZB Options",
		NewZBExplicit(Options(0xaa)),
		[]byte{zbExplicitAPIID, 0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0xaa}},
	{"ZB Data",
		NewZBExplicit(Data([]byte{'h','e','l','l','o'})),
		[]byte{zbExplicitAPIID, 0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 'h','e','l','l','o'}},
}

func TestZBExplicit(t *testing.T) {
	t.Parallel()

	t.Run("ZB Test Suite", func(t *testing.T) {
		for _, tt := range zbTests {
			tt := tt

			t.Run(tt.name, func(t *testing.T) {
				t.Parallel()

				actual, err := tt.input.Bytes()
				if err != nil {
					t.Fatalf("Expected no error, but got: %v", err)
				}
				if len(actual) != len(tt.expected) {
					t.Fatalf("Expected ATRemote frame to be %d bytes in length, got: %d", len(tt.expected), len(actual))
				}
				for i, b := range actual {
					if b != tt.expected[i] {
						t.Fatalf("Expected 0x%02x, but got 0x%02x at index %d", b, actual[i], i)
					}
				}
			})
		}
	})
}

